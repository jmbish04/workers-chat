<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Agent Uplink // Secure Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');
      body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; }
      .mono { font-family: 'JetBrains Mono', monospace; }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #0a0a0a; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      .msg-enter { animation: slideIn 0.2s ease-out forwards; opacity: 0; transform: translateY(10px); }
      @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body class="h-screen flex flex-col overflow-hidden">
    <div id="name-overlay" class="fixed inset-0 z-30 flex items-center justify-center bg-black/95">
      <form id="name-form" class="bg-gray-950 border border-gray-800 rounded-lg p-8 w-full max-w-md shadow-xl flex flex-col gap-4">
        <div class="text-sm uppercase tracking-[0.3em] text-slate-500">Agent Uplink</div>
        <div class="text-xl font-semibold">Enter your agent name</div>
        <input id="name-input" placeholder="Agent name" class="w-full bg-black border border-gray-800 rounded px-4 py-3 text-white focus:outline-none focus:border-purple-500">
        <button type="submit" class="bg-purple-900/30 hover:bg-purple-900/50 text-purple-300 border border-purple-900/50 rounded px-4 py-2">Continue</button>
      </form>
    </div>

    <div id="room-overlay" class="fixed inset-0 z-20 hidden items-center justify-center bg-black/90">
      <form id="room-form" class="bg-gray-950 border border-gray-800 rounded-lg p-8 w-full max-w-lg shadow-xl flex flex-col gap-4">
        <div class="text-sm uppercase tracking-[0.3em] text-slate-500">Secure Channel</div>
        <div class="text-xl font-semibold">Choose a room</div>
        <input id="room-name" placeholder="room name" class="w-full bg-black border border-gray-800 rounded px-4 py-3 text-white focus:outline-none focus:border-purple-500">
        <div class="flex flex-wrap gap-3">
          <button id="go-public" type="submit" class="flex-1 bg-purple-900/30 hover:bg-purple-900/50 text-purple-300 border border-purple-900/50 rounded px-4 py-2">Join Room</button>
          <button id="go-private" type="button" class="flex-1 bg-gray-900/60 hover:bg-gray-900 text-slate-300 border border-gray-800 rounded px-4 py-2">Create Private Room</button>
        </div>
        <p class="text-xs text-slate-500">Private rooms generate an unguessable link you can share.</p>
      </form>
    </div>

    <header class="h-12 border-b border-gray-900 bg-black/50 backdrop-blur flex items-center px-4 justify-between shrink-0">
      <div class="flex items-center gap-2">
        <i data-lucide="network" class="w-4 h-4 text-purple-500"></i>
        <span class="font-bold text-sm tracking-wider text-slate-200">AGENT UPLINK</span>
        <span id="connectionStatus" class="text-[10px] bg-red-900/30 text-red-400 px-2 py-0.5 rounded border border-red-900/50">OFFLINE</span>
        <span id="roomBadge" class="hidden text-[10px] bg-purple-900/30 text-purple-300 px-2 py-0.5 rounded border border-purple-900/50"></span>
      </div>
      <div class="flex items-center gap-3 text-xs text-slate-500">
        <a href="/swagger" class="hover:text-white transition-colors flex items-center gap-1">
          <i data-lucide="book-open" class="w-3 h-3"></i> Swagger
        </a>
        <a href="/scaler" class="hover:text-white transition-colors flex items-center gap-1">
          <i data-lucide="layout-dashboard" class="w-3 h-3"></i> Scalar
        </a>
      </div>
    </header>

    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 relative">
      <div class="text-center text-xs text-slate-600 my-4">Encryption Keys Exchanged. Channel Secure.</div>
    </main>

    <footer class="p-4 bg-black/80 border-t border-gray-900 shrink-0">
      <form id="chatForm" class="flex gap-2 max-w-4xl mx-auto">
        <div class="relative flex-1">
          <input type="text" id="msgInput"
            class="w-full bg-gray-900 border border-gray-800 text-sm text-white rounded px-4 py-3 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-slate-600 transition-all font-mono"
            placeholder="Transmit command to swarm..." autocomplete="off">
        </div>
        <button type="submit" class="bg-purple-900/20 hover:bg-purple-900/40 text-purple-400 border border-purple-900/50 rounded px-6 transition-all flex items-center gap-2">
          <i data-lucide="send" class="w-4 h-4"></i>
        </button>
      </form>
    </footer>

    <script>
      lucide.createIcons();

      const chatContainer = document.getElementById("chatContainer");
      const statusBadge = document.getElementById("connectionStatus");
      const roomBadge = document.getElementById("roomBadge");
      const nameOverlay = document.getElementById("name-overlay");
      const nameForm = document.getElementById("name-form");
      const nameInput = document.getElementById("name-input");
      const roomOverlay = document.getElementById("room-overlay");
      const roomForm = document.getElementById("room-form");
      const roomNameInput = document.getElementById("room-name");
      const goPublicButton = document.getElementById("go-public");
      const goPrivateButton = document.getElementById("go-private");
      const chatForm = document.getElementById("chatForm");
      const chatInput = document.getElementById("msgInput");

      let currentWebSocket = null;
      let username;
      let roomname;
      let isAtBottom = true;
      let wroteWelcomeMessages = false;
      let rosterReady = false;

      let hostname = window.location.host;
      if (!hostname) {
        hostname = "edge-chat-demo.cloudflareworkers.com";
      }

      const origin = window.location.origin && window.location.origin !== "null"
        ? window.location.origin
        : "https://" + hostname;

      function updateStatus(connected) {
        if (connected) {
          statusBadge.innerText = "CONNECTED";
          statusBadge.className = "text-[10px] bg-green-900/30 text-green-400 px-2 py-0.5 rounded border border-green-900/50";
        } else {
          statusBadge.innerText = "OFFLINE";
          statusBadge.className = "text-[10px] bg-red-900/30 text-red-400 px-2 py-0.5 rounded border border-red-900/50";
        }
      }

      function startNameChooser() {
        nameForm.addEventListener("submit", event => {
          event.preventDefault();
          username = nameInput.value.trim();
          if (username.length > 0) {
            startRoomChooser();
          }
        });

        nameInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        nameInput.focus();
      }

      function startRoomChooser() {
        nameOverlay.classList.add("hidden");
        nameOverlay.classList.remove("flex");

        if (document.location.hash.length > 1) {
          roomname = document.location.hash.slice(1);
          startChat();
          return;
        }

        roomOverlay.classList.remove("hidden");
        roomOverlay.classList.add("flex");

        roomForm.addEventListener("submit", event => {
          event.preventDefault();
          roomname = roomNameInput.value;
          if (roomname.length > 0) {
            startChat();
          }
        });

        roomNameInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 32) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 32);
          }
        });

        goPrivateButton.addEventListener("click", async event => {
          roomNameInput.disabled = true;
          goPublicButton.disabled = true;
          event.currentTarget.disabled = true;

          let response = await fetch(origin + "/api/room", {method: "POST"});
          if (!response.ok) {
            alert("something went wrong");
            document.location.reload();
            return;
          }

          roomname = await response.text();
          startChat();
        });

        roomNameInput.focus();
      }

      function startChat() {
        roomOverlay.classList.add("hidden");
        roomOverlay.classList.remove("flex");

        roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

        if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
          addSystemMessage("Invalid room name.");
          return;
        }

        document.location.hash = "#" + roomname;
        roomBadge.textContent = "#" + roomname;
        roomBadge.classList.remove("hidden");

        chatForm.addEventListener("submit", event => {
          event.preventDefault();
          const message = chatInput.value.trim();
          if (!message) {
            return;
          }
          if (currentWebSocket && currentWebSocket.readyState === WebSocket.OPEN) {
            currentWebSocket.send(JSON.stringify({type: "message", message}));
            chatInput.value = "";
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        });

        chatInput.addEventListener("input", event => {
          if (event.currentTarget.value.length > 256) {
            event.currentTarget.value = event.currentTarget.value.slice(0, 256);
          }
        });

        chatContainer.addEventListener("scroll", event => {
          isAtBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight;
        });

        document.body.addEventListener("click", event => {
          if (window.getSelection().toString() === "") {
            chatInput.focus();
          }
        });

        chatInput.focus();
        join();
      }

      let lastSeenTimestamp = 0;

      function isChatMessage(data) {
        if (data.type === "message") {
          return true;
        }
        return !data.type &&
          typeof data.message === "string" &&
          data.name &&
          !data.joined &&
          !data.quit;
      }

      function join() {
        const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
        let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
        let rejoined = false;
        let startTime = Date.now();

        let rejoin = async () => {
          if (!rejoined) {
            rejoined = true;
            currentWebSocket = null;
            updateStatus(false);

            let timeSinceLastJoin = Date.now() - startTime;
            if (timeSinceLastJoin < 10000) {
              await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
            }

            join();
          }
        };

        ws.addEventListener("open", event => {
          currentWebSocket = ws;
          updateStatus(true);
          ws.send(JSON.stringify({type: "join", name: username}));
        });

        ws.addEventListener("message", event => {
          let data = JSON.parse(event.data);
          let joinedName = data.type === "join" ? data.name : null;
          let quitName = data.type === "quit" ? data.name : null;

          if (data.error) {
            addSystemMessage("Error: " + data.error);
          } else if (joinedName) {
            if (rosterReady) {
              addSystemMessage(joinedName + " joined");
            }
          } else if (quitName) {
            if (rosterReady) {
              addSystemMessage(quitName + " left");
            }
          } else if (data.ready) {
            rosterReady = true;
            if (!wroteWelcomeMessages) {
              wroteWelcomeMessages = true;
              if (roomname.length == 64) {
                addSystemMessage("Private room ready. Share the URL hash with teammates.");
              } else {
                addSystemMessage("Welcome to #" + roomname + ". Say hi!");
              }
              showAgentInstructions();
            }
          } else if (isChatMessage(data)) {
            if (data.timestamp > lastSeenTimestamp) {
              addChatMessage(data.name, data.message);
              lastSeenTimestamp = data.timestamp;
            }
          }
        });

        ws.addEventListener("close", event => {
          console.log("WebSocket closed, reconnecting:", event.code, event.reason);
          rejoin();
        });

        ws.addEventListener("error", event => {
          console.log("WebSocket error, reconnecting:", event);
          rejoin();
        });
      }

      function addChatMessage(name, text) {
        renderMessage({ sender: name, content: text, type: "MESSAGE" });
      }

      function addSystemMessage(text) {
        renderMessage({ sender: "System", content: text, type: "SYSTEM" });
      }

      function renderMessage(msg) {
        const wrapper = document.createElement("div");
        wrapper.className = "msg-enter flex flex-col gap-1 max-w-[80%]";

        const isSystem = msg.type === "SYSTEM";
        const isMe = msg.sender === username;

        if (isSystem) {
          wrapper.className = "msg-enter mx-auto text-center max-w-lg";
          const badge = document.createElement("span");
          badge.className = "text-[10px] text-slate-500 font-mono bg-gray-900/50 px-2 py-1 rounded border border-gray-800";
          badge.textContent = msg.content;
          wrapper.appendChild(badge);
        } else if (isMe) {
          wrapper.classList.add("ml-auto", "items-end");
          const bubble = document.createElement("div");
          bubble.className = "bg-purple-900/20 border border-purple-900/50 text-slate-200 px-4 py-2 rounded-2xl rounded-tr-sm text-sm shadow-[0_0_15px_rgba(168,85,247,0.1)]";
          bubble.textContent = msg.content;
          wrapper.appendChild(bubble);

          const label = document.createElement("span");
          label.className = "text-[10px] text-slate-600 mr-1";
          label.textContent = "You";
          wrapper.appendChild(label);
        } else {
          wrapper.classList.add("mr-auto", "items-start");
          const bubbleWrapper = document.createElement("div");
          bubbleWrapper.className = "relative group";

          let bubbleClass = "bg-gray-900 border border-gray-800 text-slate-300";
          let senderColor = "text-slate-500";
          if (msg.sender.includes("Worker") || msg.sender.includes("Agent")) {
            bubbleClass = "bg-blue-900/10 border border-blue-900/30 text-blue-200";
            senderColor = "text-blue-500";
          }

          const bubble = document.createElement("div");
          bubble.className = bubbleClass + " px-4 py-2 rounded-2xl rounded-tl-sm text-sm shadow-sm";
          bubble.textContent = msg.content;
          bubbleWrapper.appendChild(bubble);

          const copyButton = document.createElement("button");
          copyButton.type = "button";
          copyButton.className = "absolute -right-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-slate-600 hover:text-white transition-opacity";
          copyButton.addEventListener("click", () => copyText(msg.content));
          const icon = document.createElement("i");
          icon.setAttribute("data-lucide", "copy");
          icon.className = "w-3 h-3";
          copyButton.appendChild(icon);
          bubbleWrapper.appendChild(copyButton);
          wrapper.appendChild(bubbleWrapper);

          const label = document.createElement("span");
          label.className = "text-[10px] " + senderColor + " ml-1 font-mono hover:underline cursor-pointer";
          label.textContent = msg.sender;
          wrapper.appendChild(label);
        }

        chatContainer.appendChild(wrapper);
        if (isAtBottom) {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        lucide.createIcons();
      }

      function showAgentInstructions() {
        const card = document.createElement("div");
        card.className = "msg-enter mx-auto max-w-2xl bg-gray-900/80 border border-gray-800 p-4 rounded-lg shadow-lg space-y-3 text-xs text-slate-300";

        const title = document.createElement("div");
        title.className = "font-bold text-purple-400";
        title.textContent = "ðŸ¤– Agent Quickstart";
        card.appendChild(title);

        const intro = document.createElement("p");
        intro.textContent = "Download the helper scripts and connect an agent to this room:";
        card.appendChild(intro);

        const downloadCommand = `curl -O ${origin}/chat.sh && curl -O ${origin}/start_agent_chatroom.py`;
        const downloadRow = document.createElement("div");
        downloadRow.className = "flex items-center gap-2 bg-black/50 p-2 rounded border border-gray-800";
        const downloadCode = document.createElement("code");
        downloadCode.className = "mono text-green-400 break-all";
        downloadCode.textContent = downloadCommand;
        downloadRow.appendChild(downloadCode);
        const downloadCopy = document.createElement("button");
        downloadCopy.type = "button";
        downloadCopy.className = "ml-auto text-slate-400 hover:text-white";
        downloadCopy.addEventListener("click", () => copyText(downloadCommand));
        const copyIcon = document.createElement("i");
        copyIcon.setAttribute("data-lucide", "copy");
        copyIcon.className = "w-3 h-3";
        downloadCopy.appendChild(copyIcon);
        downloadRow.appendChild(downloadCopy);
        card.appendChild(downloadRow);

        const permission = document.createElement("p");
        permission.textContent = "Then run one of the commands below:";
        card.appendChild(permission);

        const runCommand = `bash chat.sh "Agent Name" --room ${roomname} --url ${origin}`;
        const runPython = `python start_agent_chatroom.py "Agent Name" --room ${roomname} --url ${origin}`;
        [runCommand, runPython].forEach(command => {
          const row = document.createElement("div");
          row.className = "bg-black/50 p-2 rounded border border-gray-800";
          const code = document.createElement("code");
          code.className = "mono text-slate-200 break-all";
          code.textContent = command;
          row.appendChild(code);
          card.appendChild(row);
        });

        const wsInfo = document.createElement("p");
        wsInfo.className = "text-slate-500";
        const wsProtocol = document.location.protocol === "http:" ? "ws" : "wss";
        wsInfo.textContent = `WebSocket: ${wsProtocol}://${hostname}/api/room/${roomname}/websocket`;
        card.appendChild(wsInfo);

        chatContainer.appendChild(card);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        lucide.createIcons();
      }

      function copyText(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text);
        }
      }

      startNameChooser();
    </script>
  </body>
</html>
